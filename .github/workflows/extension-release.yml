name: Chrome Extension Release

on:
    workflow_dispatch:
    push:
        tags:
            - "ext-v*"

permissions:
    contents: write

jobs:
    release-extension:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Get version from manifest
              id: version
              run: |
                  VERSION=$(jq -r '.version' ghost-extension/manifest.json)
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  echo "Extension version: $VERSION"

            - name: Create extension zip
              run: |
                  cd ghost-extension
                  zip -r ../os-ghost-extension-v${{ steps.version.outputs.VERSION }}.zip . \
                      -x "*.md" \
                      -x "screenshots/*" \
                      -x ".git/*" \
                      -x ".DS_Store"
                  cd ..
                  ls -la *.zip

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: os-ghost-extension-v${{ steps.version.outputs.VERSION }}
                  path: os-ghost-extension-v${{ steps.version.outputs.VERSION }}.zip

            - name: Publish to Chrome Web Store
              continue-on-error: true # May fail until extension is approved
              uses: trmcnvn/chrome-addon@v2
              with:
                  extension: ${{ secrets.EXTENSION_ID }}
                  zip: os-ghost-extension-v${{ steps.version.outputs.VERSION }}.zip
                  client-id: ${{ secrets.CWS_CLIENT_ID }}
                  client-secret: ${{ secrets.CWS_CLIENT_SECRET }}
                  refresh-token: ${{ secrets.CWS_REFRESH_TOKEN }}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: os-ghost-extension-v${{ steps.version.outputs.VERSION }}.zip
                  name: "The OS Ghost Extension v${{ steps.version.outputs.VERSION }}"
                  body: |
                      ## Chrome Extension v${{ steps.version.outputs.VERSION }}

                      This extension connects Chrome to The OS Ghost desktop app.

                      **Install from Chrome Web Store** (recommended) or download the zip below.
                  draft: false
                  prerelease: false
